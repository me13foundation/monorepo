'use client'

import { useEffect, useMemo, useState, useTransition } from 'react'
import { DashboardSection } from '@/components/ui/composition-patterns'
import { Button } from '@/components/ui/button'
import { toast } from 'sonner'
import type {
  OrchestratedSessionState,
  SourceCatalogEntry,
  ValidationIssueDTO,
} from '@/types/generated'
import {
  addSpaceDiscoverySources,
  updateSpaceDiscoverySelection,
} from '@/app/actions/space-discovery'
import { SourceCatalog } from '@/components/data-discovery/SourceCatalog'

interface DataDiscoveryContentProps {
  spaceId: string
  orchestratedState: OrchestratedSessionState | null
  catalog: SourceCatalogEntry[]
  errorMessage?: string | null
  isModal?: boolean
  onComplete?: () => void
}

export function DataDiscoveryContent({
  spaceId,
  orchestratedState,
  catalog,
  errorMessage,
  isModal = false,
  onComplete,
}: DataDiscoveryContentProps) {
  const [state, setState] = useState<OrchestratedSessionState | null>(orchestratedState)
  const [selectedIds, setSelectedIds] = useState<Set<string>>(
    () => new Set(orchestratedState?.session.selected_sources ?? []),
  )
  const [isAdding, setIsAdding] = useState(false)
  const [isPending, startTransition] = useTransition()

  useEffect(() => {
    setState(orchestratedState)
  }, [orchestratedState])

  useEffect(() => {
    if (!state) {
      setSelectedIds(new Set())
      return
    }
    setSelectedIds(new Set(state.session.selected_sources))
  }, [state?.session.selected_sources, state])

  const issues: ValidationIssueDTO[] = state?.validation?.issues ?? []
  const isValid = state?.validation?.is_valid !== false

  const groupedCatalog = useMemo(() => {
    const groups: Record<string, SourceCatalogEntry[]> = {}
    catalog.forEach((entry) => {
      const key = entry.category || 'Uncategorized'
      if (!groups[key]) {
        groups[key] = []
      }
      groups[key].push(entry)
    })
    return groups
  }, [catalog])

  const handleToggle = (sourceId: string) => {
    if (!state) {
      toast.error('Discovery session is unavailable. Please refresh.')
      return
    }
    const previousSelection = state.session.selected_sources
    const next = new Set(selectedIds)
    if (next.has(sourceId)) {
      next.delete(sourceId)
    } else {
      next.add(sourceId)
    }

    setSelectedIds(next)

    startTransition(async () => {
      const result = await updateSpaceDiscoverySelection(
        state.session.id,
        Array.from(next),
        `/spaces/${spaceId}/data-sources`,
      )

      if (!result.success) {
        toast.error(result.error)
        setSelectedIds(new Set(previousSelection))
        return
      }

      setState(result.state)
    })
  }

  const handleAddSelectedToSpace = async () => {
    if (!state) {
      toast.error('Discovery session is unavailable. Please refresh.')
      return
    }
    if (selectedIds.size === 0) {
      toast.error('Select at least one source to add.')
      return
    }
    setIsAdding(true)
    const idsToPromote = Array.from(selectedIds)
    const result = await addSpaceDiscoverySources(
      state.session.id,
      spaceId,
      idsToPromote,
      `/spaces/${spaceId}/data-sources`,
    )

    if (!result.success) {
      toast.error(result.error)
      setIsAdding(false)
      return
    }

    setIsAdding(false)
    toast.success(
      idsToPromote.length === 1
        ? 'Source added to this space.'
        : `${idsToPromote.length} sources added to this space.`,
    )
    onComplete?.()
  }

  const SelectView = () => {
    if (errorMessage) {
      return (
        <div className="rounded-lg border border-destructive/40 bg-destructive/10 p-4 text-sm text-destructive">
          {errorMessage}
        </div>
      )
    }

    if (!state) {
      return (
        <div className="rounded-lg border border-dashed border-muted-foreground/40 bg-muted/40 p-4 text-sm text-muted-foreground">
          Loading discovery session...
        </div>
      )
    }

    if (catalog.length === 0) {
      return <div className="p-4 text-center text-muted-foreground">No sources available</div>
    }

    return (
      <SourceCatalog
        groupedEntries={groupedCatalog}
        selectedIds={selectedIds}
        onToggle={handleToggle}
        isPending={isPending}
        validationIssues={issues}
        isValid={isValid}
      />
    )
  }

  const ModalLayout = ({ children }: { children: React.ReactNode }) => (
    <div className="flex h-full flex-col">
      <div className="flex-1 overflow-hidden">
        <div className="h-full p-1">{children}</div>
      </div>
      <div className="border-t bg-background p-4">
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="text-sm text-muted-foreground">
            {selectedIds.size} source{selectedIds.size === 1 ? '' : 's'} selected
          </div>
          <Button
            onClick={handleAddSelectedToSpace}
            disabled={isAdding || selectedIds.size === 0 || isPending}
          >
            {isAdding || isPending ? 'Adding...' : 'Add selected to space'}
          </Button>
        </div>
      </div>
    </div>
  )

  const StandardLayout = ({ children }: { children: React.ReactNode }) => (
    <div className="space-y-6">
      <DashboardSection
        title="Select Sources"
        description="Pick sources to add directly to this research space"
      >
        {children}
      </DashboardSection>

      {state && (
        <div className="rounded-md border bg-muted/30 p-4 text-sm text-muted-foreground">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium text-foreground">Session overview</div>
              <div>Selected sources: {state.view_context.selected_count}</div>
              <div>Total available: {state.view_context.total_available}</div>
            </div>
            <Button variant="outline" disabled={!state.view_context.can_run_search}>
              {state.view_context.can_run_search
                ? 'Run search (backend orchestrated)'
                : 'Select at least one source'}
            </Button>
          </div>
        </div>
      )}

    </div>
  )

  const Layout = isModal ? ModalLayout : StandardLayout

  return <Layout><SelectView /></Layout>
}
