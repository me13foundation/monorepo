import { redirect } from 'next/navigation'
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { fetchMyMembership, fetchResearchSpace, fetchSpaceMembers } from '@/lib/api/research-spaces'
import { canManageMembers } from '@/components/research-spaces/role-utils'
import { MembershipRole, type ResearchSpace, type ResearchSpaceMembership } from '@/types/research-space'
import { UserRole } from '@/types/auth'
import SpaceMembersClient from '../space-members-client'

interface SpaceMembersPageProps {
  params: {
    spaceId: string
  }
}

export default async function SpaceMembersPage({ params }: SpaceMembersPageProps) {
  const session = await getServerSession(authOptions)
  const token = session?.user?.access_token

  if (!session || !token) {
    redirect('/auth/login?error=SessionExpired')
  }

  let space: ResearchSpace | null = null
  let memberships: ResearchSpaceMembership[] = []
  let membersError: string | null = null
  let currentMembership: ResearchSpaceMembership | null = null

  try {
    space = await fetchResearchSpace(params.spaceId, token)
  } catch (error) {
    console.error('[SpaceMembersPage] Failed to fetch research space', error)
  }

  try {
    const membershipResponse = await fetchSpaceMembers(params.spaceId, undefined, token)
    memberships = membershipResponse.memberships
  } catch (error) {
    membersError =
      error instanceof Error ? error.message : 'Unable to load members for this space.'
    console.error('[SpaceMembersPage] Failed to fetch members', error)
  }

  try {
    currentMembership = await fetchMyMembership(params.spaceId, token)
  } catch (error) {
    console.error('[SpaceMembersPage] Failed to fetch membership', error)
  }

  const isPlatformAdmin = session.user.role === UserRole.ADMIN
  const hasSpaceAccess = isPlatformAdmin || Boolean(currentMembership)
  const matchedMembership = memberships.find(
    (membership) => membership.user_id === session.user.id,
  )
  const effectiveRole =
    matchedMembership?.role ??
    currentMembership?.role ??
    (isPlatformAdmin ? MembershipRole.ADMIN : MembershipRole.VIEWER)
  const canManageMembersFlag = isPlatformAdmin || canManageMembers(effectiveRole)
  const isOwner = effectiveRole === MembershipRole.OWNER
  const canEditSpace = isOwner || isPlatformAdmin
  const showMembershipNotice = !currentMembership && !isPlatformAdmin

  return (
    <SpaceMembersClient
      spaceId={params.spaceId}
      space={space}
      memberships={memberships}
      membersError={membersError}
      access={{
        hasSpaceAccess,
        canManageMembers: canManageMembersFlag,
        canEditSpace,
        isOwner,
        showMembershipNotice,
      }}
    />
  )
}
